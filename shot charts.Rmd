---
title: "Basketball shot charts with R"
output: html_document
date: '2022-07-20'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(BasketballAnalyzeR)
library(plotly)

RNGkind(sample.kind = "Rounding")
```

```{r}

PbP <- PbPmanipulation(PbP.BDB)
str(PbP)
subdata <- subset(PbP, player=="Stephen Curry")


subdata %>% ggplot(aes(original_x, original_y)) +
  geom_point()

subdata$xx <- subdata$original_x/10
subdata$yy <- subdata$original_y/10-41.75

shotchart(data=subdata, x="xx", y="yy", scatter = T,
          pt.col = "blue",
          bg.col = "yellow")

shotchart(data=subdata, x="xx", y="yy", scatter = T, 
          z = 'result',
          bg.col = "black",
          courtline.col = "white",
          palette = 'hot')

shotchart(data=subdata, x="xx", y="yy", scatter = T, 
          num.sect = 5,
          type = "sectors",
          z = 'playlength')


shotchart(data=subdata, x="xx", y="yy", scatter = F, 
          num.sect = 5,
          type = "sectors",
          z = 'playlength',
          result = 'result')


```

#interactive plot
```{r}


Pbox.sel <- subset(Pbox, MIN >= 500)
attach(Pbox.sel)
X <- data.frame(Player, AST/MIN, TOV/MIN, PTSpm = PTS/MIN)
Xnomin <- data.frame(Player, AST, TOV, PTS)
detach(Pbox.sel)

#do this for points, not turnovers
Xnomin <- Xnomin %>% mutate(Shooter = case_when(
  PTS < 581 ~ "Hesitant",
  (PTS >= 581 & PTS < 1000) ~ "2nd option",
  PTS >= 1000 ~ "Shooter")
  )
mypal <- colorRampPalette(c("blue", "yellow", "red"))

p6 <- scatterplot(Xnomin, data.var = c("AST", "TOV"),
                  z.var = "PTS", 
                  palette = mypal,
                  labels = Xnomin$Player)

p6 
p6 + geom_smooth(aes(x = Xnomin$AST, y = Xnomin$TOV), method = lm)
ggplotly(p6, tooltip = "text")


p7 <- Xnomin %>% ggplot(aes(x = AST, y = TOV, color = Shooter)) +
  geom_point() +
  scale_color_manual(values = c("yellow", "red",  "green" ), aesthetics = "color")

p7
ggplotly(p7, tooltip = "all")

data <- Pbox[1:50, c("PTS","P3M","P2M","OREB","Team")]
scatterplot(data, data.var=1:4, z.var="Team")

```

#looking at time to shoot vs time elapsed in game
```{r}
shots <- PbP %>% filter(ShotType %in% c("2P", "3P"))

shots <- shots %>% filter(playlength <= 24) #somehow there are 283 plays longer than 24 seconds

#take out overtime games
shots <- shots %>% filter(totalTime <= 2880)

shots %>% ggplot(aes(x = playlength, y = result)) + geom_boxplot()

shots %>% ggplot(aes(x = totalTime, y = playlength)) + geom_point() + geom_smooth(method = "lm") + facet_wrap(~ result)

shots %>% group_by(result) %>% summarise(mean_time = mean(playlength))

per1 <- shots %>% filter(totalTime <= 720) %>% group_by(totalTime) %>% summarise(mean_time = mean(playlength))

per1 %>% ggplot(aes(x = totalTime, y = mean_time)) + geom_point()

perall <- shots %>% group_by(totalTime) %>% summarise(mean_time = mean(playlength))

perall %>% ggplot(aes(x = totalTime, y = mean_time)) +
  geom_point() + 
  scale_y_continuous(limits = c(11, 12.6) ) +
  geom_smooth(method = "lm")

```